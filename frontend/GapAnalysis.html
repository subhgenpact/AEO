<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gap Analysis</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Gap Analysis specific styling */
    .text-purple {
        color: #9c27b0 !important;
    }
    
    .kpi-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .kpi-number {
        font-family: 'Arial', sans-serif;
        font-weight: 700;
    }
    
    .kpi-label {
        font-size: 0.9rem;
    }
    
    .kpi-status {
        font-size: 0.75rem;
    }
    
    /* Table specific styling */
    #gapAnalysisTable {
        font-size: 0.875rem;
    }
    
    #gapAnalysisTable th {
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
        vertical-align: middle;
    }
    
    #gapAnalysisTable td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }
    
    #gapAnalysisTable tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .table-responsive {
        border-radius: 0.375rem;
    }
    
    .pagination-sm .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .badge {
        font-size: 0.7rem;
        font-weight: 600;
    }
  </style>
</head>

<body>

  <div class="container-fluid p-0 w-100">

    <!-- Header -->
    <header class="header d-flex align-items-center justify-content-between px-4 fixed-top">
      <!-- Logo and Title (left) -->
      <div class="d-flex align-items-center">
        <div class="logo me-3">
          <a href="index.html">
            <svg width="120" height="48" viewBox="0 0 167 64" fill="none" xmlns="http://www.w3.org/2000/svg" class="genpact-logo">
              <g id="Group 1597881160">
                <g id="Group">
                  <path id="Vector" d="M70.6328 37.8217C71.2676 39.0041 72.5372 39.8266 73.9823 39.8266C76.0893 39.8266 77.7776 38.1044 77.7776 35.9967V35.8554L77.7236 35.8297C76.5485 36.9349 75.0358 37.6032 73.3476 37.6032C69.7279 37.6032 66.8105 34.4674 66.8105 30.6375C66.8105 26.8077 69.7414 23.6719 73.3476 23.6719C75.0358 23.6719 76.5485 24.353 77.7236 25.484L77.7776 25.4583V24.0446H81.1541V35.9967C81.1541 39.7752 78.1693 42.821 74.1309 42.821C71.4162 42.821 69.0661 41.4716 67.7965 39.4153L70.6328 37.8346V37.8217ZM74.0634 34.6345C76.1974 34.6345 77.9802 32.8609 77.9802 30.6375C77.9802 28.4142 76.1974 26.6406 74.0634 26.6406C71.9294 26.6406 70.1736 28.4142 70.1736 30.6375C70.1736 32.8609 71.9564 34.6345 74.0634 34.6345Z" fill="black"></path>
                  <path id="Vector_2" d="M92.9314 33.3366L95.2814 35.5085C93.9173 36.8066 92.0264 37.5905 89.9465 37.5905C85.7866 37.5905 82.4775 34.4932 82.4775 30.6249C82.4775 26.7565 85.7055 23.6592 89.7439 23.6592C93.7822 23.6592 96.9697 26.7565 96.9697 30.6249C96.9697 31.2417 96.9157 31.4088 96.9157 31.4088H85.8541C85.8541 32.8739 87.6909 34.5961 89.7979 34.5961C91.0405 34.5961 92.121 34.082 92.9314 33.3237M93.323 28.7999L93.35 28.7485C92.5937 27.4505 91.2701 26.5765 89.7304 26.5765C88.1907 26.5765 86.8941 27.3991 86.0837 28.7485L86.1107 28.7999H93.3095H93.323Z" fill="black"></path>
                  <path id="Vector_3" d="M101.764 30.6377V37.2307H98.3877V24.0319H101.764V25.6384L101.818 25.6641C102.966 24.3403 104.506 23.6592 106.1 23.6592C112.124 23.6592 112.272 28.787 112.272 30.3678V37.2178H108.896V30.6249C108.896 29.0441 108.869 26.6279 105.37 26.6279C103.385 26.6279 101.751 28.4015 101.751 30.6249" fill="black"></path>
                  <path id="Vector_4" d="M121.74 37.6034C120.025 37.6034 118.539 36.9608 117.337 35.8041L117.283 35.8298V42.4485H113.906V24.0319H117.283V25.407L117.337 25.4327C118.539 24.3275 120.025 23.6592 121.74 23.6592C125.36 23.6592 128.277 26.7565 128.277 30.6249C128.277 34.4932 125.346 37.5905 121.74 37.5905M121.011 26.6279C118.836 26.6279 117.094 28.4015 117.094 30.5991C117.094 32.7968 118.85 34.6089 121.011 34.6089C123.117 34.6089 124.9 32.8354 124.9 30.5991C124.9 28.3629 123.117 26.6279 121.011 26.6279Z" fill="black"></path>
                  <path id="Vector_5" d="M135.963 23.6719C137.651 23.6719 139.15 24.353 140.325 25.484L140.393 25.4583V24.0446H143.769V37.2434H140.393V35.8939L140.325 35.8425C139.15 36.9349 137.638 37.6161 135.963 37.6161C132.343 37.6161 129.426 34.5188 129.426 30.6504C129.426 26.782 132.357 23.6847 135.963 23.6847M136.692 34.6087C138.84 34.6087 140.582 32.8609 140.582 30.6375C140.582 28.4142 138.84 26.6278 136.692 26.6278C134.545 26.6278 132.802 28.4013 132.802 30.6375C132.802 32.8738 134.585 34.6087 136.692 34.6087Z" fill="black"></path>
                  <path id="Vector_6" d="M157.869 35.5085C156.519 36.8066 154.614 37.5905 152.534 37.5905C148.374 37.5905 145.065 34.4932 145.065 30.6249C145.065 26.7565 148.388 23.6592 152.534 23.6592C154.614 23.6592 156.519 24.4431 157.869 25.7412L155.492 27.8232C154.736 27.0649 153.709 26.6151 152.534 26.6151C150.238 26.6151 148.442 28.4143 148.442 30.6249C148.442 32.8354 150.252 34.5961 152.534 34.5961C153.709 34.5961 154.79 34.1205 155.546 33.3494L157.869 35.4957V35.5085Z" fill="black"></path>
                  <path id="Vector_7" d="M164.663 27.0907V37.2307H161.287V27.0907H158.95V24.0448H161.287V18.1201H164.663V24.0448H167V27.0907H164.663Z" fill="black"></path>
                </g>
                <path id="Vector_8" d="M48.9177 31.2892C48.9177 31.2892 48.8707 31.2445 48.8472 31.2222C48.8119 31.1775 48.7766 31.1329 48.7296 31.0994L37.3848 23.8548L48.7296 16.5097C48.8942 16.4092 48.9882 16.2306 48.9882 16.052C48.9882 15.8734 48.8942 15.6948 48.7296 15.5943L24.8292 0.100465C24.6293 -0.0334882 24.3707 -0.0334882 24.1708 0.100465L0.258637 15.5943C0.258637 15.5943 0.164587 15.6837 0.117562 15.7395C0.117562 15.7506 0.0940499 15.7618 0.0822937 15.7841C0.0352687 15.8623 0 15.9627 0 16.0632V47.0621C0 47.2519 0.0940499 47.4193 0.258637 47.5198L24.1708 63.0248C24.1708 63.0248 24.1943 63.0248 24.2061 63.0248C24.2061 63.0248 24.2178 63.036 24.2296 63.0472C24.3001 63.0807 24.3824 63.0918 24.453 63.103C24.4647 63.103 24.4882 63.1141 24.5 63.1141C24.594 63.1141 24.6881 63.0918 24.7704 63.0472C24.7821 63.0472 24.7939 63.0248 24.8057 63.0248H24.8292L48.7414 47.5198C48.9059 47.4193 49 47.2407 49 47.0621V31.5682C49 31.4678 48.9647 31.3785 48.9177 31.3003V31.2892ZM13.2258 24.1673L24.5 16.8557L35.304 23.8659L24.1708 31.0994C24.1708 31.0994 24.112 31.1664 24.0885 31.1887C24.0533 31.2222 24.018 31.2445 23.9945 31.2892C23.971 31.3338 23.971 31.3785 23.9592 31.4343C23.9592 31.4789 23.9239 31.5124 23.9239 31.5571V45.89L13.2375 38.958V24.1673H13.2258ZM35.3628 39.2817L25.0878 45.89V32.6175L35.3628 39.2929V39.2817ZM36.4091 38.6119L25.5463 31.5571L36.3503 24.5357L47.3659 31.5682L36.4091 38.6119ZM24.5 1.23906L47.3659 16.0632L36.3385 23.1962L24.8174 15.7283C24.6176 15.5943 24.3589 15.5943 24.1591 15.7283L12.6262 23.2073L1.63412 16.0632L24.5 1.23906ZM1.17562 17.1236L12.0501 24.1673V39.2482C12.0501 39.438 12.1442 39.6054 12.3088 39.7059L23.9122 47.2296V61.5067L1.17562 46.7719V17.1236ZM47.8244 46.7719L25.0878 61.5067V47.2407L25.4875 46.984L47.8244 32.6175V46.7719Z" fill="black"></path>
              </g>
            </svg>
          </a>
        </div>
        <div class="navbar-title">
          <span style="font-size: 16px; font-weight: 600; color: var(--gray-800);">AEO â€“ Material Management Tool</span>
        </div>
      </div>
    
      <!-- Navigation Menu (right) -->
      <nav class="navbar-nav">
        <ul class="nav-menu d-flex list-unstyled mb-0">
          <li class="nav-item me-3 dropdown">
            <a href="index.html" class="nav-link">
              Home
            </a>
          </li>
          <li class="nav-item me-3 dropdown">
            <a href="#engine-delivery" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown">
              Engine Delivery <i class="fas fa-chevron-down ms-1"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="demand.html">Demand</a></li>
              <li><a class="dropdown-item" href="BOMexplosion.html">BOM Explosion</a></li>
              <li><a class="dropdown-item" href="GapAnalysis.html">GAP Analysis</a></li>
            </ul>
          </li>
          <li class="nav-item me-3 dropdown">
            <a href="#fulfillment-expediting" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
              Fulfillment <i class="fas fa-chevron-down ms-1"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Buyback</a></li>
              <li><a class="dropdown-item" href="#">Line up change actions</a></li>
              <li><a class="dropdown-item" href="#">Part Escalation actions</a></li>
            </ul>
          </li>
          <li class="nav-item me-3 dropdown">
            <a href="#sourcing" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
              Sourcing <i class="fas fa-chevron-down ms-1"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Say do-ratio</a></li>
              <li><a class="dropdown-item" href="#">Quality instances</a></li>
              <li><a class="dropdown-item" href="#">L/T management / Costing</a></li>
              <li><a class="dropdown-item" href="#">Alternate sources / escalation</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a href="#critical-order" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
              Critical Order <i class="fas fa-chevron-down ms-1"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="4critical_demand.html">Demand</a></li>
              <li><a class="dropdown-item" href="4critical_gapAnalysis.html">GAP Analysis</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </header>

  </div>

  <!-- Gap Analysis Dashboard Content -->
  <div class="container dashboard-mode" style="padding-top: 80px;">
    
    <!-- Filter Section -->
    <div class="d-flex gap-2 mb-3 justify-content-between align-items-center">
      <div class="filters-inline" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
          <!-- 0: Product Line -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="productLineDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                Product Line
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="productLineSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllProductLines"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearProductLines" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyProductLines">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 1: Year -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="yearDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                Year
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="yearSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllYears"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearYears" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyYears">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 2: Eng Config -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="engConfigDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                Engine Config
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="engConfigSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllConfigs"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearConfigs" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyConfigs">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 3: Supplier -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="supplierDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                Supplier
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="supplierSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllSuppliers"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearSuppliers"
                    title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applySuppliers">Apply</button>
                </div>
              </div>
            </div>
          </div>
           <!-- 4: RM Supplier (subset of Supplier) -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="rmSupplierDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                RM Supplier
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="rmSupplierSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllRmSuppliers"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearRmSuppliers" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyRmSuppliers">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 5: HW Owner -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="hwOwnerDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                HW Owner
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="hwOwnerSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllHwOwners"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearHwOwners" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyHwOwners">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 6: Module -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="moduleDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                Module
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="moduleSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllModules"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearModules" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyModules">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <!-- 7: Part No -->
          <div class="filter-item">
            <div class="dropdown-filter">
              <button class="form-select form-select-sm" type="button" id="partNoDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                aria-expanded="false">
                Part No
              </button>
              <div class="dropdown-menu py-2 px-1" style="width: 260px;">
                <div class="d-flex gap-1 mb-2">
                  <input type="text" class="form-control form-control-sm" id="partNoSearch" placeholder="Search..."
                    style="flex: 1;">
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="selectAllPartNos"
                    title="Select All">All</button>
                  <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="clearPartNos" title="Clear">Ã—</button>
                </div>
                <div class="dropdown-options mb-2" style="max-height: 180px; overflow-y: auto;">
                  <!-- Options will be populated dynamically by JavaScript -->
                </div>
                <div class="d-flex justify-content-end border-top pt-2">
                  <button class="btn btn-sm btn-primary w-100" id="applyPartNos">Apply</button>
                </div>
              </div>
            </div>
          </div>
         
        </div>
        
        <!-- Clear All Button (Extreme Right) -->
        <button class="btn btn-sm" id="clearAllFilters" style="background-color: #ff6600; color: white; border: none; white-space: nowrap;">
          <i class="fas fa-times-circle me-1"></i>Clear All
        </button>
    </div>
    
    <!-- Gap Analysis KPIs -->
    <div class="d-flex gap-3 mb-4 flex-wrap" id="gap-analysis-kpis">
      <!-- Total Gaps KPI -->
      <div class="flex-fill">
        <div class="card kpi-card h-100" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196f3;">
          <div class="card-body text-center p-3">
            <div class="kpi-number text-primary fw-bold" style="font-size: 2rem;" id="totalGapsCount">12</div>
            <div class="kpi-label text-dark fw-semibold mt-1">Total Gaps</div>
            <div class="kpi-status text-muted small mt-1" id="totalGapsStatus">Status: 12% Gap</div>
          </div>
        </div>
      </div>

      <!-- Critical Priority KPI -->
      <div class="flex-fill">
        <div class="card kpi-card h-100" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #f44336;">
          <div class="card-body text-center p-3">
            <div class="kpi-number text-danger fw-bold" style="font-size: 2rem;" id="criticalPriorityCount">2</div>
            <div class="kpi-label text-dark fw-semibold mt-1">Critical Priority</div>
            <div class="kpi-status text-muted small mt-1" id="criticalPriorityStatus">Status: Past Due</div>
          </div>
        </div>
      </div>

      <!-- High Priority KPI -->
      <div class="flex-fill">
        <div class="card kpi-card h-100" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-left: 4px solid #ff9800;">
          <div class="card-body text-center p-3">
            <div class="kpi-number text-warning fw-bold" style="font-size: 2rem;" id="highPriorityCount">3</div>
            <div class="kpi-label text-dark fw-semibold mt-1">High Priority</div>
            <div class="kpi-status text-muted small mt-1" id="highPriorityStatus">Status: Due in next 3 weeks</div>
          </div>
        </div>
      </div>

      <!-- Medium Priority KPI -->
      <div class="flex-fill">
        <div class="card kpi-card h-100" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 4px solid #9c27b0;">
          <div class="card-body text-center p-3">
            <div class="kpi-number text-purple fw-bold" style="font-size: 2rem;" id="mediumPriorityCount">4</div>
            <div class="kpi-label text-dark fw-semibold mt-1">Medium Priority</div>
            <div class="kpi-status text-muted small mt-1" id="mediumPriorityStatus">Status: Missing commits</div>
          </div>
        </div>
      </div>

      <!-- Low Priority KPI -->
      <div class="flex-fill">
        <div class="card kpi-card h-100" style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-left: 4px solid #4caf50;">
          <div class="card-body text-center p-3">
            <div class="kpi-number text-success fw-bold" style="font-size: 2rem;" id="lowPriorityCount">3</div>
            <div class="kpi-label text-dark fw-semibold mt-1">Low Priority</div>
            <div class="kpi-status text-muted small mt-1" id="lowPriorityStatus">Status: Late commits</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Priority Action Items Table -->
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">ðŸ“‹ Priority Action Items - Gap Records Only</h5>
          <small class="text-muted">Showing only records with identified gaps (Have Gap = Y)</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <span class="badge bg-primary" id="totalRecordsCount">Loading...</span>
          <button class="btn btn-sm btn-outline-secondary" id="refreshTableBtn">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Table Controls -->
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
          <div class="d-flex gap-2 align-items-center">
            <label for="recordsPerPage" class="form-label mb-0 small">Show:</label>
            <select class="form-select form-select-sm" id="recordsPerPage" style="width: auto;">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="small text-muted">records per page</span>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <label for="tableSearch" class="form-label mb-0 small">Search:</label>
            <input type="text" class="form-control form-control-sm" id="tableSearch" placeholder="Search records..." style="width: 200px;">
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="gapAnalysisTable">
            <thead class="table-dark">
              <tr>
                <th scope="col" class="text-center">Priority</th>
                <th scope="col">RM Part</th>
                <th scope="col">Parent Part Number</th>
                <th scope="col">ESN</th>
                <th scope="col">Status</th>
                <th scope="col">Due Date</th>
                <th scope="col">Action Required</th>
                <th scope="col" class="text-center">Email</th>
                <th scope="col" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Table Loading -->
        <div id="tableLoading" class="text-center py-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 mb-0">Loading table data...</p>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="text-center py-4" style="display: none;">
          <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
          <p class="text-muted mb-0">No records found matching your criteria.</p>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center p-3 border-top">
          <div class="small text-muted" id="paginationInfo">
            Showing 0 to 0 of 0 entries
          </div>
          <nav aria-label="Table pagination">
            <ul class="pagination pagination-sm mb-0" id="paginationControls">
              <!-- Pagination will be populated by JavaScript -->
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Loading indicator -->
    <div id="loadingIndicator" class="text-center py-4" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading Gap Analysis data...</p>
    </div>

    <!-- Error message -->
    <div id="errorMessage" class="alert alert-danger" style="display: none;">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <span id="errorText">Failed to load data. Please try again.</span>
    </div>

  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Gap Analysis Dashboard JavaScript
    class GapAnalysisDashboard {
      constructor() {
        this.filters = {
          productLines: [],
          years: [],
          configs: [],
          suppliers: [],
          rmSuppliers: [],
          hwOwners: [],
          modules: [],
          partNumbers: []
        };
        this.filterOptions = {};
        this.gapAnalysisData = [];
        this.tableData = [];
        this.allTableData = []; // Store all data for client-side filtering
        this.priorityFilter = null; // Active priority filter from KPI clicks
        this.isLoadingData = false; // Flag to prevent loading loops
        this.kpiData = {
          totalGaps: { count: 12, status: '12% Gap' },
          criticalPriority: { count: 2, status: 'Past Due' },
          highPriority: { count: 3, status: 'Due in next 3 weeks' },
          lowPriority: { count: 3, status: 'Late commits' },
          mediumPriority: { count: 4, status: 'Missing commits' },
          onTrack: { count: 85, status: 'Meeting targets' }
        };
        
        // Table pagination settings
        this.currentPage = 1;
        this.recordsPerPage = 10;
        this.totalRecords = 0;
        this.searchQuery = '';
        
        this.init();
      }

      async init() {
        try {
          console.log('Initializing Gap Analysis Dashboard...');
          this.showLoading(true);
          
          console.log('Step 1: Loading filter options...');
          await this.loadFilterOptions();
          
          console.log('Step 2: Loading gap analysis data...');
          await this.loadGapAnalysisData();
          
          console.log('Step 3: Loading table data...');
          await this.loadTableData();
          
          console.log('Step 4: Setting up event listeners...');
          this.setupEventListeners();
          
          console.log('Step 5: Updating KPIs...');
          this.updateKPIs();
          
          console.log('Dashboard initialization complete!');
          this.showLoading(false);
        } catch (error) {
          console.error('Failed to initialize Gap Analysis dashboard:', error);
          this.showError(`Failed to initialize dashboard: ${error.message}. Please refresh the page.`);
        }
      }

      showLoading(show) {
        const loadingEl = document.getElementById('loadingIndicator');
        const errorEl = document.getElementById('errorMessage');
        
        if (show) {
          loadingEl.style.display = 'block';
          errorEl.style.display = 'none';
        } else {
          loadingEl.style.display = 'none';
        }
      }

      showError(message) {
        const errorEl = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const loadingEl = document.getElementById('loadingIndicator');
        
        errorText.textContent = message;
        errorEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }

      async loadFilterOptions() {
        try {
          console.log('Loading filter options...');
          // Load filter options from the backend API
          const response = await fetch('/api/datatable/filter-options');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Filter options loaded:', data);
          this.filterOptions = data.filterOptions || {};
          
          // Populate filter dropdowns
          this.populateFilterDropdown('productLines', this.filterOptions.productLines || []);
          this.populateFilterDropdown('years', this.filterOptions.years || []);
          this.populateFilterDropdown('configs', this.filterOptions.configs || []);
          this.populateFilterDropdown('suppliers', this.filterOptions.suppliers || []);
          this.populateFilterDropdown('rmSuppliers', this.filterOptions.rmSuppliers || []);
          this.populateFilterDropdown('hwOwners', this.filterOptions.hwOwners || []);
          this.populateFilterDropdown('modules', this.filterOptions.modules || []);
          this.populateFilterDropdown('partNumbers', this.filterOptions.partNumbers || []);
          
          console.log('Filter dropdowns populated');
        } catch (error) {
          console.error('Failed to load filter options:', error);
          // Don't throw error, continue with empty options
          this.filterOptions = {
            productLines: [],
            years: ['2025', '2026', '2027'],
            configs: [],
            suppliers: [],
            rmSuppliers: [],
            hwOwners: [],
            modules: [],
            partNumbers: []
          };
          console.log('Using fallback filter options');
        }
      }

      populateFilterDropdown(filterType, options) {
        try {
          const mappings = {
            'productLines': 'productLine',
            'years': 'year',
            'configs': 'engConfig',
            'suppliers': 'supplier',
            'rmSuppliers': 'rmSupplier',
            'hwOwners': 'hwOwner',
            'modules': 'module',
            'partNumbers': 'partNo'
          };
          
          const dropdownId = mappings[filterType];
          if (!dropdownId) {
            console.warn(`No mapping found for filter type: ${filterType}`);
            return;
          }
          
          const dropdown = document.querySelector(`#${dropdownId}Dropdown`);
          if (!dropdown) {
            console.warn(`Dropdown not found: #${dropdownId}Dropdown`);
            return;
          }
          
          const container = dropdown.nextElementSibling?.querySelector('.dropdown-options');
          if (!container) {
            console.warn(`Container not found for dropdown: ${dropdownId}`);
            return;
          }
          
          container.innerHTML = '';
          
          if (!Array.isArray(options)) {
            console.warn(`Options is not an array for ${filterType}:`, options);
            return;
          }
          
          options.forEach((option, index) => {
            if (option && option.toString().trim()) {
              const div = document.createElement('div');
              div.className = 'form-check';
              const safeId = `${dropdownId}_${index}`;
              div.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${option}" id="${safeId}">
                <label class="form-check-label" for="${safeId}">
                  ${option}
                </label>
              `;
              container.appendChild(div);
            }
          });
          
          console.log(`Populated ${filterType} with ${options.length} options`);
        } catch (error) {
          console.error(`Error populating filter dropdown ${filterType}:`, error);
        }
      }

      async loadGapAnalysisData() {
        try {
          console.log('Loading gap analysis data...');
          // Load KPI data from backend API
          const response = await fetch('/api/gap-analysis/kpis');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Gap analysis KPIs loaded from API:', data);
          this.kpiData = data.kpis || this.kpiData;
          
          console.log('Gap analysis KPI data loaded successfully');
        } catch (error) {
          console.error('Failed to load gap analysis KPIs:', error);
          // Keep default mock data if API fails
          console.log('Using default KPI data');
        }
      }

      transformToGapAnalysisFormat(demandData) {
        // Transform demand data into gap analysis format
        // This is a simplified transformation - in reality you'd have supply data too
        const gapData = [];
        
        demandData.forEach(item => {
          // Simulate supply data (in reality this would come from supply planning)
          const demand = item.No || 0;
          const supply = Math.floor(demand * (0.7 + Math.random() * 0.4)); // Random supply between 70-110% of demand
          const gap = demand - supply;
          
          gapData.push({
            period: `${item.Year}-${item.Mon}`,
            program: item.PL,
            demand: demand,
            supply: supply,
            gap: gap,
            year: item.Year,
            month: item.Mon
          });
        });
        
        return gapData;
      }

      createMockGapData() {
        // Create mock gap analysis data for testing
        const mockData = [];
        const programs = ['LM2500', 'LM6000', 'LMS100'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        
        programs.forEach(program => {
          months.forEach(month => {
            const demand = Math.floor(Math.random() * 50) + 10;
            const supply = Math.floor(demand * (0.7 + Math.random() * 0.4));
            const gap = demand - supply;
            
            mockData.push({
              period: `2025-${month}`,
              program: program,
              demand: demand,
              supply: supply,
              gap: gap,
              year: 2025,
              month: month
            });
          });
        });
        
        return mockData;
      }

      transformDemandDataToTable(demandData) {
        // Transform demand data to table format
        const tableData = [];
        
        demandData.forEach(program => {
          program.configs?.forEach(config => {
            config.esns?.forEach(esn => {
              config.level1Parts?.forEach(part => {
                // Simulate gap status based on target date and other factors
                const targetDate = new Date(esn.targetShipDate);
                const now = new Date();
                const daysDiff = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
                
                // Consider it a gap if:
                // - Past due (negative days)
                // - Due within 21 days and no supplier info
                // - Random factor for demonstration (60% chance)
                const hasGap = daysDiff < 0 || 
                              (daysDiff <= 21 && !part.supplier) || 
                              Math.random() < 0.6 ? 'Y' : 'N';
                
                tableData.push({
                  'ENGINE_PROGRAM': program.engineProgram,
                  'Configuration': config.config,
                  'ESN': esn.esn,
                  'Part_Number': part.pn,
                  'Target_Ship_Date': esn.targetShipDate,
                  'Parent_Part_Supplier': part.supplier,
                  'HW_OWNER': part.hwo?.join(', ') || '',
                  'Level_2_PN': part.level2Parts?.[0]?.pn || part.pn,
                  'Level_2_Raw_Material_Supplier': part.level2Parts?.[0]?.rmSupplier || '',
                  'Have_Gap': hasGap,
                  'Gap_Y_N': hasGap,
                  'Gap (Y/N)': hasGap
                });
              });
            });
          });
        });
        
        return tableData;
      }

      createMockTableData() {
        // Create mock table data for testing
        const mockData = [];
        const programs = ['LM2500', 'LM6000', 'LMS100'];
        const configs = ['Standard', 'Premium', 'Sport'];
        const suppliers = ['ABC Automotive', 'XYZ Electronics', 'Tech Solutions'];
        const hwOwners = ['John Smith', 'Sarah Johnson', 'Mike Chen'];
        
        for (let i = 0; i < this.recordsPerPage * 2; i++) { // Create more records to have some with gaps
          const program = programs[Math.floor(Math.random() * programs.length)];
          const config = configs[Math.floor(Math.random() * configs.length)];
          const supplier = suppliers[Math.floor(Math.random() * suppliers.length)];
          const hwOwner = hwOwners[Math.floor(Math.random() * hwOwners.length)];
          
          // Create some past due dates to simulate gaps
          const futureDate = new Date();
          const daysOffset = Math.floor(Math.random() * 180) - 60; // -60 to +120 days
          futureDate.setDate(futureDate.getDate() + daysOffset);
          
          // Determine if this record has a gap (70% chance for demonstration)
          const hasGap = Math.random() < 0.7 ? 'Y' : 'N';
          
          mockData.push({
            'ENGINE_PROGRAM': program,
            'Configuration': config,
            'ESN': `ESN-${2025}-${String(i + 1).padStart(3, '0')}`,
            'Part_Number': `PN-${Math.floor(Math.random() * 9000) + 1000}`,
            'Target_Ship_Date': futureDate.toISOString().split('T')[0],
            'Parent_Part_Supplier': supplier,
            'HW_OWNER': hwOwner,
            'Level_2_PN': `RM-${Math.floor(Math.random() * 9000) + 1000}`,
            'Level_2_Raw_Material_Supplier': `RM ${supplier}`,
            'Have_Gap': hasGap,
            'Gap_Y_N': hasGap, // Alternative column name
            'Gap (Y/N)': hasGap // Another possible column name
          });
        }
        
        return mockData;
      }

      filterGapRecords(data) {
        // Filter records to show only those with gaps
        if (!Array.isArray(data)) {
          console.warn('Data is not an array:', data);
          return [];
        }
        
        const filteredData = data.filter(record => {
          // Check multiple possible column names for gap indicator
          const hasGap = record['Have_Gap'] || 
                        record['Gap_Y_N'] || 
                        record['Gap (Y/N)'] || 
                        record['Gap_YN'] ||
                        record['have_gap'] ||
                        record['gap_y_n'] ||
                        record['gap_yn'];
          
          // Return true if the record has a gap (Y, Yes, true, 1)
          if (typeof hasGap === 'string') {
            return hasGap.toUpperCase() === 'Y' || hasGap.toUpperCase() === 'YES';
          }
          if (typeof hasGap === 'boolean') {
            return hasGap;
          }
          if (typeof hasGap === 'number') {
            return hasGap === 1;
          }
          
          // If no gap indicator found, simulate based on priority
          // (for existing data that doesn't have gap indicators)
          const priority = this.calculateRowPriority(record);
          return priority === 'P1' || priority === 'P2'; // Consider P1 and P2 as having gaps
        });
        
        console.log(`Filtered ${data.length} records to ${filteredData.length} gap records`);
        return filteredData;
      }

      setupEventListeners() {
        // Clear all filters button
        document.getElementById('clearAllFilters').addEventListener('click', () => {
          this.clearAllFilters();
        });

        // Setup filter event listeners for each filter type
        const filterTypes = ['productLine', 'year', 'engConfig', 'supplier', 'rmSupplier', 'hwOwner', 'module', 'partNo'];
        
        filterTypes.forEach(filterType => {
          this.setupFilterEventListeners(filterType);
        });

        // Add click handlers for KPI cards
        this.setupKPIClickHandlers();

        // Table event listeners
        this.setupTableEventListeners();
      }

      setupFilterEventListeners(filterType) {
        const applyBtn = document.getElementById(`apply${filterType.charAt(0).toUpperCase() + filterType.slice(1)}s`);
        const clearBtn = document.getElementById(`clear${filterType.charAt(0).toUpperCase() + filterType.slice(1)}s`);
        const selectAllBtn = document.getElementById(`selectAll${filterType.charAt(0).toUpperCase() + filterType.slice(1)}s`);
        
        if (applyBtn) {
          applyBtn.addEventListener('click', () => {
            this.applyFilter(filterType);
          });
        }
        
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            this.clearFilter(filterType);
          });
        }
        
        if (selectAllBtn) {
          selectAllBtn.addEventListener('click', () => {
            this.selectAllFilter(filterType);
          });
        }
      }

      applyFilter(filterType) {
        const container = document.querySelector(`#${filterType}Dropdown`).nextElementSibling.querySelector('.dropdown-options');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
        
        const filterKey = this.getFilterKey(filterType);
        this.filters[filterKey] = Array.from(checkboxes).map(cb => cb.value);
        
        this.currentPage = 1; // Reset to first page when filters change
        this.updateKPIs();
        this.loadTableData();
      }

      clearFilter(filterType) {
        const container = document.querySelector(`#${filterType}Dropdown`).nextElementSibling.querySelector('.dropdown-options');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        const filterKey = this.getFilterKey(filterType);
        this.filters[filterKey] = [];
        
        this.currentPage = 1; // Reset to first page when filters change
        this.updateKPIs();
        this.loadTableData();
      }

      selectAllFilter(filterType) {
        const container = document.querySelector(`#${filterType}Dropdown`).nextElementSibling.querySelector('.dropdown-options');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        
        this.applyFilter(filterType);
      }

      getFilterKey(filterType) {
        const mappings = {
          'productLine': 'productLines',
          'year': 'years',
          'engConfig': 'configs',
          'supplier': 'suppliers',
          'rmSupplier': 'rmSuppliers',
          'hwOwner': 'hwOwners',
          'module': 'modules',
          'partNo': 'partNumbers'
        };
        return mappings[filterType] || filterType;
      }

      clearAllFilters() {
        // Clear all filter selections
        Object.keys(this.filters).forEach(key => {
          this.filters[key] = [];
        });
        
        // Uncheck all checkboxes
        document.querySelectorAll('.dropdown-options input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
        
        this.currentPage = 1; // Reset to first page when filters change
        this.updateKPIs();
        this.loadTableData();
      }

      updateKPIs() {
        // Use the KPI data loaded from the API
        const kpis = this.kpiData;
        
        // Update KPI displays
        this.updateKPIDisplay('totalGapsCount', kpis.totalGaps.count);
        this.updateKPIDisplay('totalGapsStatus', `Status: ${kpis.totalGaps.status}`);
        
        this.updateKPIDisplay('criticalPriorityCount', kpis.criticalPriority.count);
        this.updateKPIDisplay('criticalPriorityStatus', `Status: ${kpis.criticalPriority.status}`);
        
        this.updateKPIDisplay('highPriorityCount', kpis.highPriority.count);
        this.updateKPIDisplay('highPriorityStatus', `Status: ${kpis.highPriority.status}`);
        
        this.updateKPIDisplay('mediumPriorityCount', kpis.mediumPriority.count);
        this.updateKPIDisplay('mediumPriorityStatus', `Status: ${kpis.mediumPriority.status}`);
        
        this.updateKPIDisplay('lowPriorityCount', kpis.lowPriority.count);
        this.updateKPIDisplay('lowPriorityStatus', `Status: ${kpis.lowPriority.status}`);
      }

      updateKPIDisplay(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = value;
        }
      }

      calculateKPIsFromData(filteredData) {
        // Calculate KPIs based on filtered gap analysis data
        const totalItems = filteredData.length;
        const totalGaps = filteredData.filter(item => item.gap > 0).length;
        const criticalGaps = filteredData.filter(item => item.gap > 50).length; // High gap threshold
        const highPriorityGaps = filteredData.filter(item => item.gap > 20 && item.gap <= 50).length;
        const mediumPriorityGaps = filteredData.filter(item => item.gap > 5 && item.gap <= 20).length;
        const lowPriorityGaps = filteredData.filter(item => item.gap > 0 && item.gap <= 5).length;
        const onTrack = filteredData.filter(item => item.gap <= 0).length;
        
        const gapPercentage = totalItems > 0 ? Math.round((totalGaps / totalItems) * 100) : 0;
        
        return {
          totalGaps: {
            count: totalGaps,
            status: `${gapPercentage}% Gap`
          },
          criticalPriority: {
            count: criticalGaps,
            status: criticalGaps > 0 ? 'Past Due' : 'None'
          },
          highPriority: {
            count: highPriorityGaps,
            status: highPriorityGaps > 0 ? 'Due in next 3 weeks' : 'None'
          },
          mediumPriority: {
            count: mediumPriorityGaps,
            status: mediumPriorityGaps > 0 ? 'Missing commits' : 'None'
          },
          lowPriority: {
            count: lowPriorityGaps,
            status: lowPriorityGaps > 0 ? 'Late commits' : 'None'
          },
          onTrack: {
            count: onTrack,
            status: onTrack > 0 ? 'Meeting targets' : 'None'
          }
        };
      }

      setupKPIClickHandlers() {
        // Add click handlers for KPI cards to filter table by priority
        const kpiCards = document.querySelectorAll('.kpi-card');
        kpiCards.forEach(card => {
          card.style.cursor = 'pointer';
          card.addEventListener('click', (e) => {
            const kpiType = this.getKPITypeFromCard(card);
            this.filterByKPI(kpiType);
          });
        });
      }

      getKPITypeFromCard(card) {
        // Determine KPI type based on the card content
        const label = card.querySelector('.kpi-label').textContent.trim();
        const typeMap = {
          'Total Gaps': 'totalGaps',
          'Critical Priority': 'criticalPriority',
          'High Priority': 'highPriority',
          'Medium Priority': 'mediumPriority',
          'Low Priority': 'lowPriority',
          'On Track': 'onTrack'
        };
        return typeMap[label] || 'unknown';
      }

      filterByKPI(kpiType) {
        // Filter table based on clicked KPI
        console.log(`Filtering by KPI: ${kpiType}`);
        
        // Map KPI type to priority filter
        const priorityFilters = {
          'criticalPriority': ['Critical', 'P1', '1', 'CRITICAL'],
          'highPriority': ['High', 'P2', '2', 'HIGH'],
          'mediumPriority': ['Medium', 'P3', '3', 'MEDIUM'],
          'lowPriority': ['Low', 'P4', '4', 'LOW'],
          'totalGaps': null // Show all gaps (no priority filter)
        };
        
        // Set priority filter
        this.priorityFilter = priorityFilters[kpiType] || null;
        
        // Reset to first page and reload data
        this.currentPage = 1;
        
        // Highlight active KPI card
        this.highlightActiveKPI(kpiType);
        
        // Reload table with filter
        this.applyTableFilters();
      }

      highlightActiveKPI(activeType) {
        // Remove active state from all cards
        document.querySelectorAll('.kpi-card').forEach(card => {
          card.classList.remove('border-primary', 'border-3');
          card.style.transform = '';
        });
        
        // Add active state to clicked card
        if (activeType && activeType !== 'totalGaps') {
          const kpiCards = document.querySelectorAll('.kpi-card');
          kpiCards.forEach(card => {
            const kpiType = this.getKPITypeFromCard(card);
            if (kpiType === activeType) {
              card.classList.add('border-primary', 'border-3');
              card.style.transform = 'scale(1.05)';
            }
          });
        }
      }

      applyTableFilters() {
        // Apply priority filter to table data
        if (!this.allTableData || this.allTableData.length === 0) {
          // If no data loaded yet and not currently loading, load it first
          if (!this.isLoadingData) {
            this.loadTableData();
          }
          return;
        }
        
        let filteredData = [...this.allTableData];
        
        // Apply priority filter
        if (this.priorityFilter && this.priorityFilter.length > 0) {
          filteredData = filteredData.filter(row => {
            const priority = String(row['Priority'] || row['PRIORITY'] || row['priority'] || '').toUpperCase().trim();
            return this.priorityFilter.some(p => String(p).toUpperCase().trim() === priority);
          });
        }
        
        // Apply search filter
        if (this.searchQuery && this.searchQuery.length > 0) {
          const query = this.searchQuery.toLowerCase();
          filteredData = filteredData.filter(row => {
            // Search across multiple columns
            const searchableText = [
              row['Level_2_PN'] || row['Level 2 PN'] || '',
              row['Part_Number'] || row['Part Number'] || row['Level_1_PN'] || '',
              row['ESN'] || '',
              row['HW_OWNER'] || row['HW OWNER'] || '',
              row['Priority'] || row['PRIORITY'] || row['priority'] || ''
            ].join(' ').toLowerCase();
            
            return searchableText.includes(query);
          });
        }
        
        // Sort by priority
        filteredData = this.sortByPriority(filteredData);
        
        // Update total records and current page data
        this.totalRecords = filteredData.length;
        
        // Apply pagination
        const startIndex = (this.currentPage - 1) * this.recordsPerPage;
        const endIndex = startIndex + this.recordsPerPage;
        this.tableData = filteredData.slice(startIndex, endIndex);
        
        // Render table
        this.renderTable();
        this.updatePagination();
        this.updateRecordsCount();
      }

      showKPIDetails(kpiType) {
        // Show detailed view for the selected KPI type
        console.log(`Showing details for KPI: ${kpiType}`);
        // This could open a modal, navigate to a detailed page, or expand a section
        // For now, just log the action
        alert(`Showing detailed view for ${kpiType.replace(/([A-Z])/g, ' $1').trim()}`);
      }

      getFilteredData() {
        let filtered = [...this.gapAnalysisData];
        
        // Apply filters
        if (this.filters.productLines.length > 0) {
          filtered = filtered.filter(item => this.filters.productLines.includes(item.program));
        }
        
        if (this.filters.years.length > 0) {
          filtered = filtered.filter(item => this.filters.years.includes(item.year.toString()));
        }
        
        return filtered;
      }

      // Sort table data by priority (P1 first, then P2, P3, P4)
      sortByPriority(data) {
        if (!data || !Array.isArray(data)) {
          return data;
        }

        return data.sort((a, b) => {
          // Get priority values from different possible column names
          const getPriority = (row) => {
            let priority = row['Priority'] || row['PRIORITY'] || row['priority'] || '';
            
            // Normalize to uppercase string for comparison
            let priorityStr = String(priority).toUpperCase().trim();
            
            // Convert priority to numeric value for comparison
            // P1 or 1 or CRITICAL or Critical -> 1
            // P2 or 2 or HIGH or High -> 2
            // P3 or 3 or MEDIUM or Medium -> 3
            // P4 or 4 or LOW or Low -> 4
            // Default to 5 (lowest) if not found
            
            if (priorityStr === 'P1' || priorityStr === '1' || priorityStr === 'CRITICAL') return 1;
            if (priorityStr === 'P2' || priorityStr === '2' || priorityStr === 'HIGH') return 2;
            if (priorityStr === 'P3' || priorityStr === '3' || priorityStr === 'MEDIUM') return 3;
            if (priorityStr === 'P4' || priorityStr === '4' || priorityStr === 'LOW') return 4;
            
            return 5; // Unknown priority goes to the end
          };

          const priorityA = getPriority(a);
          const priorityB = getPriority(b);

          // Sort ascending (P1 first, P4 last)
          return priorityA - priorityB;
        });
      }

      // Table Management Methods
      async loadTableData() {
        try {
          console.log('Loading table data...');
          this.isLoadingData = true; // Set loading flag
          this.showTableLoading(true);
          
          // Try the gap analysis API first - load ALL gap records for client-side filtering
          try {
            const response = await fetch(`/api/gap-analysis/all?skip=0&limit=10000`); // Load all records
            
            if (response.ok) {
              const data = await response.json();
              console.log('Gap analysis data loaded from API:', data);
              
              // Store all data for filtering
              this.allTableData = this.sortByPriority(data.data || []);
              this.isLoadingData = false; // Clear loading flag
              
              // Apply filters (priority, search, etc.)
              this.applyTableFilters();
              
              this.showTableLoading(false);
              return;
            }
          } catch (apiError) {
            console.warn('Gap analysis API failed, trying alternative:', apiError);
          }
          
          // Fallback: try datatable API and filter client-side
          try {
            const response = await fetch(`/api/datatable/all?skip=0&limit=10000`); // Load all records
            
            if (response.ok) {
              const data = await response.json();
              console.log('Table data loaded from datatable API:', data);
              
              // Filter for records with gaps only
              let filteredData = this.filterGapRecords(data.data || []);
              
              // Store all data for filtering
              this.allTableData = this.sortByPriority(filteredData);
              
              // Apply filters
              this.applyTableFilters();
              
              this.showTableLoading(false);
              return;
            }
          } catch (apiError) {
            console.warn('Datatable API failed, trying demand API:', apiError);
          }
          
          // Fallback: try demand API
          try {
            const response = await fetch('/api/demand/programs?skip=0&limit=100');
            if (response.ok) {
              const data = await response.json();
              console.log('Using demand data as fallback:', data);
              
              // Transform demand data to table format
              let transformedData = this.transformDemandDataToTable(data.data || []);
              
              // Filter for records with gaps only
              let filteredData = this.filterGapRecords(transformedData);
              
              // Store all data for filtering
              this.allTableData = this.sortByPriority(filteredData);
              this.isLoadingData = false; // Clear loading flag
              
              // Apply filters
              this.applyTableFilters();
              
              this.showTableLoading(false);
              return;
            }
          } catch (demandError) {
            console.warn('Demand API also failed:', demandError);
          }
          
          // Final fallback: use mock data
          console.log('Using mock table data');
          let mockData = this.createMockTableData();
          
          // Filter for records with gaps only
          let filteredData = this.filterGapRecords(mockData);
          
          // Store all data for filtering
          this.allTableData = this.sortByPriority(filteredData);
          this.isLoadingData = false; // Clear loading flag
          
          // Apply filters
          this.applyTableFilters();
          
          this.showTableLoading(false);
          
        } catch (error) {
          console.error('Failed to load table data:', error);
          this.isLoadingData = false; // Clear loading flag on error
          this.showTableLoading(false);
          this.showNoData(true);
        }
      }

      setupTableEventListeners() {
        // Records per page change
        document.getElementById('recordsPerPage').addEventListener('change', (e) => {
          this.recordsPerPage = parseInt(e.target.value);
          this.currentPage = 1; // Reset to first page
          this.applyTableFilters(); // Use filter method instead of reload
        });

        // Search input
        const searchInput = document.getElementById('tableSearch');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            this.searchQuery = e.target.value.trim();
            this.currentPage = 1; // Reset to first page
            this.applyTableFilters(); // Use filter method instead of reload
          }, 500); // Debounce search
        });

        // Refresh button
        document.getElementById('refreshTableBtn').addEventListener('click', () => {
          this.priorityFilter = null; // Clear filters
          this.searchQuery = '';
          document.getElementById('tableSearch').value = '';
          this.highlightActiveKPI(null); // Remove highlights
          this.loadTableData(); // Reload all data
        });
      }

      showTableLoading(show) {
        const loadingEl = document.getElementById('tableLoading');
        const tableEl = document.getElementById('gapAnalysisTable');
        const noDataEl = document.getElementById('noDataMessage');
        
        if (show) {
          loadingEl.style.display = 'block';
          tableEl.style.display = 'none';
          noDataEl.style.display = 'none';
        } else {
          loadingEl.style.display = 'none';
          tableEl.style.display = 'table';
        }
      }

      showNoData(show) {
        const noDataEl = document.getElementById('noDataMessage');
        const tableEl = document.getElementById('gapAnalysisTable');
        
        if (show) {
          noDataEl.style.display = 'block';
          tableEl.style.display = 'none';
        } else {
          noDataEl.style.display = 'none';
          tableEl.style.display = 'table';
        }
      }

      renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (this.tableData.length === 0) {
          this.showNoData(true);
          return;
        }

        this.showNoData(false);

        this.tableData.forEach((row, index) => {
          const tr = document.createElement('tr');
          
          // Get priority from database or calculate if not available
          const priority = row['Priority'] || row['PRIORITY'] || row['priority'] || this.calculateRowPriority(row);
          const priorityBadge = this.getPriorityBadge(priority);
          
          // Format target date (Due Date)
          const dueDate = this.formatDate(row['Target_Ship_Date'] || row['Target Ship Date']);
          
          // Determine status based on available data
          const status = this.determineStatus(row);
          const statusBadge = this.getStatusBadge(status);

          // Get action required (based on gap status and priority)
          const actionRequired = this.getActionRequired(row, priority);
          
          // Get HW Owner for email
          const hwOwner = row['HW_OWNER'] || row['HW OWNER'] || 'N/A';

          tr.innerHTML = `
            <td class="text-center">${priorityBadge}</td>
            <td class="fw-semibold">${row['Level_2_PN'] || row['Level 2 PN'] || 'N/A'}</td>
            <td>${row['Part_Number'] || row['Part Number'] || row['Level_1_PN'] || 'N/A'}</td>
            <td>${row['ESN'] || 'N/A'}</td>
            <td>${statusBadge}</td>
            <td class="small">${dueDate}</td>
            <td>${actionRequired}</td>
            <td class="text-center">
              <button class="btn btn-outline-info btn-sm" onclick="gapDashboard.emailAction(${index})" title="Email ${hwOwner}">
                <i class="fas fa-envelope me-1"></i>${hwOwner}
              </button>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-success btn-sm" onclick="gapDashboard.closeAction(${index})" title="Close">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="gapDashboard.commentAction(${index})" title="Comment">
                  <i class="fas fa-comment"></i>
                </button>
              </div>
            </td>
          `;
          
          tbody.appendChild(tr);
        });
      }

      getActionRequired(row, priority) {
        // Determine action required based on priority and gap status
        const priorityStr = String(priority).toUpperCase().trim();
        
        if (priorityStr === 'P1' || priorityStr === '1' || priorityStr === 'CRITICAL') {
          return '<span class="badge bg-danger">Immediate Action</span>';
        } else if (priorityStr === 'P2' || priorityStr === '2' || priorityStr === 'HIGH') {
          return '<span class="badge bg-warning text-dark">Expedite</span>';
        } else if (priorityStr === 'P3' || priorityStr === '3' || priorityStr === 'MEDIUM') {
          return '<span class="badge bg-info">Monitor</span>';
        } else if (priorityStr === 'P4' || priorityStr === '4' || priorityStr === 'LOW') {
          return '<span class="badge bg-secondary">Track</span>';
        }
        return '<span class="badge bg-secondary">Review</span>';
      }

      calculateRowPriority(row) {
        // Simple priority calculation based on available data
        // In a real implementation, this would use more sophisticated logic
        const targetDate = new Date(row['Target_Ship_Date'] || row['Target Ship Date']);
        const now = new Date();
        const daysDiff = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 0) return 'P1'; // Past due
        if (daysDiff <= 21) return 'P2'; // Due in next 3 weeks
        if (daysDiff <= 60) return 'P3'; // Due in next 2 months
        return 'P4'; // Future
      }

      getPriorityBadge(priority) {
        // Normalize priority to uppercase string for comparison
        const priorityStr = String(priority || '').toUpperCase().trim();
        
        // Map priority values to badges
        // Critical -> P1, High -> P2, Medium -> P3, Low -> P4
        const badges = {
          'P1': '<span class="badge bg-danger">P1 - Critical</span>',
          '1': '<span class="badge bg-danger">P1 - Critical</span>',
          'CRITICAL': '<span class="badge bg-danger">P1 - Critical</span>',
          
          'P2': '<span class="badge bg-warning text-dark">P2 - High</span>',
          '2': '<span class="badge bg-warning text-dark">P2 - High</span>',
          'HIGH': '<span class="badge bg-warning text-dark">P2 - High</span>',
          
          'P3': '<span class="badge bg-info">P3 - Medium</span>',
          '3': '<span class="badge bg-info">P3 - Medium</span>',
          'MEDIUM': '<span class="badge bg-info">P3 - Medium</span>',
          
          'P4': '<span class="badge bg-secondary">P4 - Low</span>',
          '4': '<span class="badge bg-secondary">P4 - Low</span>',
          'LOW': '<span class="badge bg-secondary">P4 - Low</span>'
        };
        
        return badges[priorityStr] || '<span class="badge bg-secondary">P4 - Low</span>';
      }

      determineStatus(row) {
        // Simple status determination - in reality this would be more complex
        const targetDate = new Date(row['Target_Ship_Date'] || row['Target Ship Date']);
        const now = new Date();
        const daysDiff = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 0) return 'Past Due';
        if (daysDiff <= 7) return 'Due Soon';
        if (daysDiff <= 21) return 'Upcoming';
        return 'On Track';
      }

      getStatusBadge(status) {
        const badges = {
          'Past Due': '<span class="badge bg-danger">Past Due</span>',
          'Due Soon': '<span class="badge bg-warning">Due Soon</span>',
          'Upcoming': '<span class="badge bg-info">Upcoming</span>',
          'On Track': '<span class="badge bg-success">On Track</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
      }

      getGapBadge(gapStatus) {
        if (typeof gapStatus === 'string') {
          if (gapStatus.toUpperCase() === 'Y' || gapStatus.toUpperCase() === 'YES') {
            return '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Gap</span>';
          } else if (gapStatus.toUpperCase() === 'N' || gapStatus.toUpperCase() === 'NO') {
            return '<span class="badge bg-success"><i class="fas fa-check"></i> No Gap</span>';
          }
        }
        if (typeof gapStatus === 'boolean') {
          return gapStatus ? 
            '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Gap</span>' :
            '<span class="badge bg-success"><i class="fas fa-check"></i> No Gap</span>';
        }
        // Default to Gap since we're filtering for gap records
        return '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Gap</span>';
      }

      formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
          });
        } catch (e) {
          return dateStr;
        }
      }

      updatePagination() {
        const totalPages = Math.ceil(this.totalRecords / this.recordsPerPage);
        const paginationEl = document.getElementById('paginationControls');
        
        paginationEl.innerHTML = '';
        
        if (totalPages <= 1) return;

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${this.currentPage - 1}">Previous</a>`;
        paginationEl.appendChild(prevLi);

        // Page numbers
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);

        if (startPage > 1) {
          const firstLi = document.createElement('li');
          firstLi.className = 'page-item';
          firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
          paginationEl.appendChild(firstLi);
          
          if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationEl.appendChild(ellipsisLi);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const li = document.createElement('li');
          li.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
          paginationEl.appendChild(li);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationEl.appendChild(ellipsisLi);
          }
          
          const lastLi = document.createElement('li');
          lastLi.className = 'page-item';
          lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
          paginationEl.appendChild(lastLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${this.currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${this.currentPage + 1}">Next</a>`;
        paginationEl.appendChild(nextLi);

        // Add click event listeners
        paginationEl.addEventListener('click', (e) => {
          e.preventDefault();
          if (e.target.tagName === 'A' && !e.target.parentElement.classList.contains('disabled')) {
            const page = parseInt(e.target.dataset.page);
            if (page && page !== this.currentPage) {
              this.currentPage = page;
              this.loadTableData();
            }
          }
        });
      }

      updateRecordsCount() {
        const start = (this.currentPage - 1) * this.recordsPerPage + 1;
        const end = Math.min(this.currentPage * this.recordsPerPage, this.totalRecords);
        
        document.getElementById('paginationInfo').textContent = 
          `Showing ${start} to ${end} of ${this.totalRecords.toLocaleString()} entries`;
        
        document.getElementById('totalRecordsCount').textContent = 
          `${this.totalRecords.toLocaleString()} Total Records`;
      }

      // Action handlers for table buttons
      closeAction(index) {
        const row = this.tableData[index];
        if (confirm(`Close action for ${row['Level_2_PN'] || row['Level 2 PN'] || 'this item'}?`)) {
          alert('Action closed successfully!');
          // In a real implementation, you would make an API call here
        }
      }

      commentAction(index) {
        const row = this.tableData[index];
        const comment = prompt(`Add comment for ${row['Level_2_PN'] || row['Level 2 PN'] || 'this item'}:`);
        if (comment && comment.trim()) {
          alert(`Comment added: "${comment}"`);
          // In a real implementation, you would make an API call here
        }
      }

      emailAction(index) {
        const row = this.tableData[index];
        const hwOwner = row['HW_OWNER'] || row['HW OWNER'] || 'owner';
        alert(`Email notification sent to ${hwOwner}`);
        // In a real implementation, you would make an API call here
      }

    }

    // Initialize the dashboard when the page loads
    let gapDashboard;
    document.addEventListener('DOMContentLoaded', () => {
      gapDashboard = new GapAnalysisDashboard();
    });
  </script>

</body>
</html>